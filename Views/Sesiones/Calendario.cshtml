@model IEnumerable<StudyHub.Models.Sesion>
@{
    ViewData["Title"] = "Calendario de Sesiones";
    var usuarioRol = Context.Session.GetString("UsuarioRol");
    var esProfesor = usuarioRol == "Profesor";
    var ahora = DateTime.UtcNow;
    var sesionesProximas = Model.Where(s => s.FechaHora > ahora).OrderBy(s => s.FechaHora);
    var sesionesPasadas = Model.Where(s => s.FechaHora <= ahora).OrderByDescending(s => s.FechaHora);
    var proximaSesion = sesionesProximas.FirstOrDefault();
    var totalSesiones = Model.Count();
    var sesionesHoy = Model.Count(s => s.FechaHora.Date == ahora.Date);
}

<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Home")">Dashboard</a></li>
            <li class="breadcrumb-item active text-muted" aria-current="page">Calendario de Sesiones</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row align-items-end mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                <div class="calendario-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
                    <i class="bi bi-calendar-week"></i>
                </div>
                <div>
                    <h1 class="h2 mb-1">Calendario de Sesiones</h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-clock-history me-1"></i>
                        Gestiona y visualiza todas las sesiones programadas
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            @if (esProfesor)
            {
                <div class="btn-group">
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Programar Sesión
                    </a>
                    <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Más opciones</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#" class="dropdown-item" id="exportCalendario">
                                <i class="bi bi-download me-2"></i>Exportar Calendario
                            </a>
                        </li>
                        <li>
                            <a href="#" class="dropdown-item" id="sincronizarCalendario">
                                <i class="bi bi-arrow-repeat me-2"></i>Sincronizar
                            </a>
                        </li>
                    </ul>
                </div>
            }
        </div>
    </div>

    <!-- Alertas -->
    <div class="alert-container mb-4">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show d-flex align-items-center" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                <div>@TempData["Success"]</div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        }
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card summary-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="summary-icon bg-primary text-white rounded-circle flex-shrink-0">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Total Sesiones</h6>
                            <h2 class="mb-0">@totalSesiones</h2>
                            <small class="text-muted">Programadas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card summary-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="summary-icon bg-success text-white rounded-circle flex-shrink-0">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Próximas</h6>
                            <h2 class="mb-0">@sesionesProximas.Count()</h2>
                            <small class="text-muted">Por venir</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card summary-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="summary-icon bg-info text-white rounded-circle flex-shrink-0">
                            <i class="bi bi-calendar-day"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Hoy</h6>
                            <h2 class="mb-0">@sesionesHoy</h2>
                            <small class="text-muted">Sesiones para hoy</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card summary-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="summary-icon bg-warning text-white rounded-circle flex-shrink-0">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <h6 class="card-title text-muted mb-1">Completadas</h6>
                            <h2 class="mb-0">@sesionesPasadas.Count()</h2>
                            <small class="text-muted">Sesiones pasadas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Panel Principal -->
        <div class="col-lg-8">
            <!-- Barra de Herramientas -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                        <div class="mb-3 mb-md-0">
                            <h5 class="mb-0">
                                <i class="bi bi-list-ul me-2"></i>
                                Todas las Sesiones
                            </h5>
                          </div>
                          <div class="d-flex flex-wrap gap-2 sesiones-toolbar">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-funnel me-1"></i>Filtrar
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item active" href="#" data-filter="all">Todas las sesiones</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="upcoming">Próximas sesiones</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="past">Sesiones pasadas</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="today">Hoy</a></li>
                                </ul>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-sort-down me-1"></i>Ordenar
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item active" href="#" data-sort="date-asc">Fecha (próximas primero)</a></li>
                                    <li><a class="dropdown-item" href="#" data-sort="date-desc">Fecha (recientes primero)</a></li>
                                    <li><a class="dropdown-item" href="#" data-sort="title">Por título</a></li>
                                    <li><a class="dropdown-item" href="#" data-sort="course">Por curso</a></li>
                                </ul>
                            </div>
                            <div class="input-group input-group-sm" style="width: 200px;">
                                <input type="text" class="form-control" placeholder="Buscar sesión..." id="searchInput">
                                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Sesiones -->
            <div class="sesiones-container">
                @if (Model.Any())
                {
                    <!-- Próxima Sesión Destacada -->
                    @if (proximaSesion != null)
                    {
                        <div class="card border-success bg-success-light mb-4" id="proximaSesionCard">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="next-session-indicator bg-success rounded-circle flex-shrink-0 me-3"></div>
                                    <div>
                                        <span class="badge bg-success mb-2">PRÓXIMA SESIÓN</span>
                                        <h4 class="mb-1">@proximaSesion.Titulo</h4>
                                        <p class="text-muted mb-0">@proximaSesion.Clase.Titulo</p>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-calendar-event text-success me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">Fecha y Hora</small>
                                                <strong>@proximaSesion.FechaHora.ToString("dd/MM/yyyy 'a las' HH:mm")</strong>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-clock text-success me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">Duración</small>
                                                <strong>@proximaSesion.DuracionMinutos minutos</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-geo-alt text-success me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">Ubicación</small>
                                                <strong>@proximaSesion.Ubicacion</strong>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(proximaSesion.EnlaceReunion))
                                        {
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-camera-video text-success me-2"></i>
                                                <div>
                                                    <small class="text-muted d-block">Reunión Virtual</small>
                                                    <a href="@proximaSesion.EnlaceReunion" target="_blank" class="btn btn-sm btn-success">
                                                        <i class="bi bi-box-arrow-up-right me-1"></i>Unirse
                                                    </a>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <div class="countdown-timer mt-3" id="countdownTimer">
                                    <small class="text-muted">La sesión comienza en:</small>
                                    <div class="d-flex gap-2 mt-1">
                                        <div class="countdown-item bg-white rounded p-2 text-center">
                                            <div class="countdown-value text-success fw-bold" id="countdownDays">00</div>
                                            <small class="text-muted">días</small>
                                        </div>
                                        <div class="countdown-item bg-white rounded p-2 text-center">
                                            <div class="countdown-value text-success fw-bold" id="countdownHours">00</div>
                                            <small class="text-muted">horas</small>
                                        </div>
                                        <div class="countdown-item bg-white rounded p-2 text-center">
                                            <div class="countdown-value text-success fw-bold" id="countdownMinutes">00</div>
                                            <small class="text-muted">minutos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Lista de Sesiones -->
                    <div id="sesionesList">
                        @foreach (var sesion in Model)
                        {
                            var esPasada = sesion.FechaHora <= ahora;
                              var esProxima = !esPasada;
                              var tiempoRestante = esProxima ? (sesion.FechaHora - ahora) : TimeSpan.Zero;
                              var epochMs = new DateTimeOffset(sesion.FechaHora).ToUnixTimeMilliseconds();
                              
                            <div class="card sesion-card border-0 shadow-sm mb-3" 
                                   data-sesion-id="@sesion.Id"
                                   data-fecha="@epochMs"
                                 data-titulo="@sesion.Titulo.ToLower()"
                                 data-curso="@sesion.Clase.Titulo.ToLower()"
                                 data-estado="@(esPasada ? "past" : "upcoming")"
                                 data-hoy="@(sesion.FechaHora.Date == ahora.Date ? "today" : "other")">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <!-- Fecha y Hora -->
                                        <div class="col-md-3 mb-3 mb-md-0">
                                            <div class="sesion-fecha text-center">
                                                <div class="sesion-dia @(esPasada ? "text-muted" : "text-primary") fw-bold">
                                                    @sesion.FechaHora.ToString("dd")
                                                </div>
                                                <div class="sesion-mes text-muted small">
                                                    @sesion.FechaHora.ToString("MMM").ToUpper()
                                                </div>
                                                <div class="sesion-hora @(esPasada ? "text-muted" : "text-success") fw-semibold">
                                                    @sesion.FechaHora.ToString("HH:mm")
                                                </div>
                                                @if (sesion.FechaHora.Date == ahora.Date)
                                                {
                                                    <span class="badge bg-info mt-1">HOY</span>
                                                }
                                            </div>
                                        </div>

                                        <!-- Información de la Sesión -->
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <h5 class="card-title mb-1">@sesion.Titulo</h5>
                                            <p class="card-text text-muted small mb-2">
                                                <i class="bi bi-journal-text me-1"></i>@sesion.Clase.Titulo
                                            </p>
                                            @if (!string.IsNullOrEmpty(sesion.Descripcion))
                                            {
                                                <p class="card-text small text-muted">@sesion.Descripcion</p>
                                            }
                                            
                                            <div class="sesion-meta">
                                                <small class="text-muted">
                                                    <i class="bi bi-clock me-1"></i>
                                                    @sesion.DuracionMinutos minutos · 
                                                    <i class="bi bi-geo-alt me-1 ms-2"></i>
                                                    @sesion.Ubicacion
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Acciones -->
                                        <div class="col-md-3 text-end">
                                            <div class="d-flex flex-column gap-2">
                                                @if (!string.IsNullOrEmpty(sesion.EnlaceReunion) && esProxima)
                                                {
                                                    <a href="@sesion.EnlaceReunion" target="_blank" 
                                                       class="btn btn-success btn-sm" title="Unirse a la reunión">
                                                        <i class="bi bi-camera-video me-1"></i>Unirse
                                                    </a>
                                                }
                                                
                                                @if (esProfesor)
                                                {
                                                    <div class="btn-group btn-group-sm">
                                                        <a asp-action="Edit" asp-route-id="@sesion.Id" 
                                                           class="btn btn-outline-warning" title="Editar sesión">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                        <form asp-action="Delete" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@sesion.Id" />
                                                            <button type="submit" class="btn btn-outline-danger" 
                                                                    title="Eliminar sesión"
                                                                    onclick="return confirm('¿Estás seguro de eliminar esta sesión?')">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                }
                                                
                                                @if (esProxima)
                                                {
                                                    <small class="text-muted">
                                                        <i class="bi bi-alarm me-1"></i>
                                                        @((int)tiempoRestante.TotalHours)h @tiempoRestante.Minutes m restantes
                                                    </small>
                                                }
                                                else
                                                {
                                                    <small class="text-muted">
                                                        <i class="bi bi-check-circle me-1"></i>
                                                        Completada
                                                    </small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Estado Vacío -->
                    <div class="card border-0 shadow-sm text-center py-5">
                        <div class="card-body">
                            <div class="empty-state-icon mb-4">
                                <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
                            </div>
                            <h4 class="text-muted mb-3">No hay sesiones programadas</h4>
                            <p class="text-muted mb-4">
                                Aún no se han programado sesiones para tus cursos.
                            </p>
                            @if (esProfesor)
                            {
                                <a asp-action="Create" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-2"></i>Programar Primera Sesión
                                </a>
                            }
                            else
                            {
                                <p class="text-muted small">
                                    Los profesores de tus cursos programarán sesiones próximamente.
                                </p>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 100px;">
                <!-- Calendario Mini -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar3 text-primary me-2"></i>
                            Calendario
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="miniCalendario"></div>
                        <div class="sesiones-hoy mt-3" id="sesionesHoyList">
                            <h6 class="text-muted mb-2">
                                <i class="bi @(sesionesHoy > 0 ? "bi-check-circle text-success" : "bi-info-circle text-muted") me-1"></i>
                                Hoy: @sesionesHoy sesión@(sesionesHoy != 1 ? "es" : "")
                            </h6>
                            @if (sesionesHoy > 0)
                            {
                                foreach (var sesion in Model.Where(s => s.FechaHora.Date == ahora.Date).Take(3))
                                {
                                    <div class="d-flex align-items-center mb-2 p-2 bg-light rounded">
                                        <i class="bi bi-circle-fill text-primary me-2" style="font-size: 0.5rem;"></i>
                                        <div class="flex-grow-1">
                                            <small class="d-block fw-semibold">@sesion.Titulo</small>
                                            <small class="text-muted">@sesion.FechaHora.ToString("HH:mm")</small>
                                        </div>
                                    </div>
                                }
                                @if (sesionesHoy > 3)
                                {
                                    <small class="text-muted">Y @(sesionesHoy - 3) más...</small>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Acciones Rápidas -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning text-warning me-2"></i>
                            Acciones Rápidas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            @if (esProfesor)
                            {
                                <a asp-action="Create" class="btn btn-outline-primary btn-sm text-start">
                                    <i class="bi bi-plus-circle me-2"></i>Nueva Sesión
                                </a>
                            }
                            <button class="btn btn-outline-secondary btn-sm text-start" id="refreshCalendario">
                                <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
                            </button>
                            <button class="btn btn-outline-info btn-sm text-start" id="viewAsCalendar">
                                <i class="bi bi-calendar-week me-2"></i>Vista Calendario
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Próximos Eventos -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-alarm text-success me-2"></i>
                            Próximos Eventos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="proximosEventosList">
                            @if (sesionesProximas.Any())
                            {
                                foreach (var sesion in sesionesProximas.Take(5))
                                {
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="event-indicator bg-success rounded flex-shrink-0 me-2 mt-1"></div>
                                        <div class="flex-grow-1">
                                            <small class="fw-semibold d-block">@sesion.Titulo</small>
                                            <small class="text-muted d-block">@sesion.Clase.Titulo</small>
                                            <small class="text-muted">
                                                <i class="bi bi-calendar-event me-1"></i>
                                                @sesion.FechaHora.ToString("dd/MM HH:mm")
                                            </small>
                                        </div>
                                    </div>
                                }
                                @if (sesionesProximas.Count() > 5)
                                {
                                    <small class="text-muted">Y @(sesionesProximas.Count() - 5) más...</small>
                                }
                            }
                            else
                            {
                                <p class="text-muted small mb-0">No hay eventos próximos programados.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="~/css/views/Sesiones.Calendario.css" asp-append-version="true" />

@section Scripts {
    <script src="~/js/views/Sesiones.Calendario.js" asp-append-version="true"></script>
}
